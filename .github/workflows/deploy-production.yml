name: Deploy to Production (DigitalOcean)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: app/startup-swipe-schedu/package-lock.json
      
      - name: ðŸ“¦ Install frontend dependencies
        working-directory: app/startup-swipe-schedu
        run: npm ci
      
      - name: ðŸ—ï¸ Build frontend for production
        working-directory: app/startup-swipe-schedu
        run: npm run build
        env:
          # Production build will use runtime hostname detection
          # This ensures production always uses tilyn.ai/api
          VITE_ENV: production
      
      - name: ðŸ“‹ Verify build output
        run: |
          echo "âœ… Build artifacts:"
          ls -lh app/startup-swipe-schedu/dist/ | head -10
          echo ""
          echo "ðŸ“Š Build size:"
          du -sh app/startup-swipe-schedu/dist/
      
      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸš€ Deploy frontend to DigitalOcean
        run: |
          echo "ðŸ“¦ Deploying frontend to production..."
          
          # Clear existing frontend directory and deploy fresh
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            # Backup old frontend
            if [ -d /home/appuser/startup-swiper/frontend ]; then
              mv /home/appuser/startup-swiper/frontend /home/appuser/startup-swiper/frontend.backup.$(date +%Y%m%d_%H%M%S)
            fi
            mkdir -p /home/appuser/startup-swiper/frontend
          EOF
          
          rsync -avz --delete \
            --exclude='*.map' \
            app/startup-swipe-schedu/dist/ \
            ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/home/appuser/startup-swiper/frontend/
          
          # Clear browser caches by updating cache-control headers in NGINX
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            echo "ðŸ”„ Clearing caches..."
            # Add timestamp to force cache invalidation
            echo "<!-- Deployed: $(date -u +%Y%m%dT%H%M%SZ) -->" >> /home/appuser/startup-swiper/frontend/index.html
          EOF
          
          echo "âœ… Frontend deployed successfully"
      
      - name: ðŸ”§ Fix permissions on server
        run: |
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            chown -R appuser:appuser /home/appuser/startup-swiper/frontend
            chmod -R 755 /home/appuser/startup-swiper/frontend
            echo "âœ… Permissions fixed"
          EOF
      
      - name: ðŸ”„ Update API code (without database)
        run: |
          echo "ðŸ“¦ Updating API code..."
          rsync -avz --delete \
            --exclude='venv' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='*.db' \
            --exclude='*.db-journal' \
            --exclude='logs/' \
            api/ \
            ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/home/appuser/startup-swiper/api/
          
          echo "âœ… API code updated"
      
      - name: ðŸ”§ Deploy NGINX configuration
        run: |
          echo "ðŸ“¦ Deploying NGINX and systemd configurations..."
          rsync -avz \
            nginx-production.conf \
            deploy-nginx.sh \
            startup-swiper.service \
            ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/home/appuser/startup-swiper/
          
          echo "ðŸ”§ Applying NGINX configuration..."
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            cd /home/appuser/startup-swiper
            
            # Deploy NGINX
            sudo bash deploy-nginx.sh || {
              echo "âš ï¸  NGINX update failed, but continuing deployment..."
              echo "   Manual NGINX configuration may be needed"
            }
            
            # Deploy systemd service
            if [ ! -f /etc/systemd/system/startup-swiper.service ]; then
              echo "ðŸ“¦ Installing systemd service..."
              sudo cp startup-swiper.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable startup-swiper
              echo "âœ… Systemd service installed"
            else
              echo "âœ… Systemd service already installed"
            fi
          EOF
          
          echo "âœ… Configuration deployed"
      
      - name: ðŸ“š Install/Update API dependencies
        run: |
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            cd /home/appuser/startup-swiper/api
            
            # Create venv if it doesn't exist
            if [ ! -d "../.venv" ]; then
              python3 -m venv ../.venv
            fi
            
            # Install/update dependencies
            ../.venv/bin/pip install -r requirements.txt --quiet
            
            echo "âœ… API dependencies updated"
          EOF
      
      - name: ðŸ”„ Restart API service
        run: |
          ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            echo "ðŸ”„ Restarting API..."
            
            # Create logs directory if it doesn't exist
            mkdir -p /home/appuser/startup-swiper/logs
            
            # Always use manual start (systemd service has issues with .env file)
            echo "Stopping existing API processes..."
            pkill -f 'uvicorn.*8000' || true
            sleep 3
            
            # Start API in background
            cd /home/appuser/startup-swiper/api
            nohup /home/appuser/startup-swiper/.venv/bin/uvicorn main:app \
              --host 0.0.0.0 \
              --port 8000 \
              --log-level info \
              > /home/appuser/startup-swiper/logs/api.log 2>&1 &
            
            echo "Waiting for API to start..."
            sleep 10
            
            # Verify API is running with retries
            for i in {1..5}; do
              if curl -sf http://localhost:8000/health > /dev/null; then
                echo "âœ… API is running and healthy"
                exit 0
              fi
              echo "Attempt $i: API not ready yet, waiting..."
              sleep 3
            done
            
            # If we get here, API didn't start properly
            echo "âŒ API failed to start. Last 50 lines of log:"
            tail -50 /home/appuser/startup-swiper/logs/api.log || echo "No log file found"
            echo ""
            echo "Checking if API process exists:"
            ps aux | grep uvicorn | grep -v grep || echo "No uvicorn process found"
            echo ""
            echo "âš ï¸  API may still be starting - check manually with:"
            echo "   ssh to server and run: tail -f /home/appuser/startup-swiper/logs/api.log"
            exit 1
          EOF
      
      - name: âœ… Verify deployment
        run: |
          echo "ðŸ§ª Testing production endpoints..."
          
          # Test API health (at root, not /api/health)
          API_HEALTH=$(curl -sf https://tilyn.ai/health || echo "failed")
          if [[ "$API_HEALTH" == "failed" ]]; then
            echo "âŒ API health check failed"
            exit 1
          fi
          echo "âœ… API is healthy"
          
          # Test frontend
          FRONTEND_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" https://tilyn.ai/ || echo "000")
          if [[ "$FRONTEND_STATUS" != "200" ]]; then
            echo "âŒ Frontend not responding (status: $FRONTEND_STATUS)"
            exit 1
          fi
          echo "âœ… Frontend is responding"
          
          echo ""
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "   Frontend: https://tilyn.ai"
          echo "   API Health: https://tilyn.ai/health"
          echo "   API Docs: https://tilyn.ai/docs"
      
      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Components:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend (React + Vite)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API (FastAPI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Not Deployed (Protected):" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Production Database" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ .env files" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ User data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View App](https://tilyn.ai)" >> $GITHUB_STEP_SUMMARY
